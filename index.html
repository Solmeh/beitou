<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æŠ•æ¢ç´¢é…å°</title>
    <style>
        .card {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            width: calc(50% - 20px);
            box-sizing: border-box;
            transition: transform 0.2s;
        }
        .card:active {
            transform: scale(0.98);
        }
        .selected {
            background-color: #ffeb3b;
            border-color: #ffc107;
        }
        .matched {
            background-color: #c8e6c9;
        }
        #timer {
            font-size: 1.5em;
            color: #d32f2f;
            padding: 10px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }
        @media (max-width: 600px) {
            .card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="timer">
        â³ å‰©ä½™æ—¶é—´ï¼š<span id="time">--:--</span>
        <div id="gameStatus"></div>
    </div>
    <div id="cardContainer"></div>
    <div class="submit-area">
        <input type="text" id="teamName" placeholder="è¼¸å…¥å°çµ„åç¨±" required>
        <button onclick="submitAnswers()" disabled>æäº¤ç­”æ¡ˆ</button>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5vmpkyiL6PTKlz5bda20SL15NV6jRdQ6ql342kGKxkQeKvLeHenJAhS2dz5e-sJz0/exec';
        let cards = [];
        let selectedCards = [];
        let matchedPairs = [];
        let gameEnded = false;

        // åˆå§‹åŒ–éŠæˆ²
        async function initGame() {
            try {
                // ç²å–éŠæˆ²ç‹€æ…‹
                const status = await fetchGameStatus();
                gameEnded = status.gameEnded;
                
                // è¼‰å…¥å¡ç‰‡è³‡æ–™
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getCards`);
                cards = await response.json();
                
                renderCards();
                startStatusChecker();
                updateSubmitButton();
            } catch (error) {
                console.error("éŠæˆ²åˆå§‹åŒ–å¤±æ•—ï¼š", error); 
                alert('éŠæˆ²åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
            }
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCards() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            
            cards.sort(() => Math.random() - 0.5).forEach(card => {
                const div = document.createElement('div');
                div.className = `card ${card.group}`;
                div.innerHTML = `
                    <h3>${card.location}</h3>
                    <p>${card.item}</p>
                    <div class="hint">${card.property}</div>
                `;
                div.onclick = () => !gameEnded && selectCard(div, card);
                container.appendChild(div);
            });
        }

        // å¡ç‰‡é¸æ“‡é‚è¼¯
        function selectCard(element, card) {
            element.classList.toggle('selected');
            const index = selectedCards.findIndex(c => c.element === element);
            
            if(index === -1) {
                selectedCards.push({ element, card });
            } else {
                selectedCards.splice(index, 1);
            }

            if(selectedCards.length === 2) {
                handlePair();
            }
        }

        // è™•ç†é…å°
        function handlePair() {
            const [card1, card2] = selectedCards;
            const color = card1.card.group === card2.card.group ? 'green' : 'red';
            
            // è¦–è¦ºåé¥‹
            card1.element.style.borderColor = color;
            card2.element.style.borderColor = color;
            
            setTimeout(() => {
                card1.element.style.borderColor = '';
                card2.element.style.borderColor = '';
            }, 1000);

            matchedPairs.push([card1.card.id, card2.card.id]);
            selectedCards.forEach(c => c.element.classList.remove('selected'));
            selectedCards = [];
        }

        // æäº¤ç­”æ¡ˆ
        async function submitAnswers() {
            const team = document.getElementById('teamName').value;
            if (!team) return alert('è«‹è¼¸å…¥å°çµ„åç¨±');

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submit',
                        team: team,
                        matches: matchedPairs
                    })
                });
                alert('ç­”æ¡ˆå·²æäº¤ï¼è«‹ç­‰å¾…æœ€çµ‚çµæœ');
            } catch (error) {
                alert('æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
            }
        }

        // éŠæˆ²ç‹€æ…‹æª¢æŸ¥
        async function fetchGameStatus() {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getStatus`);
            return res.json();
        }

        // å®šæœŸæª¢æŸ¥ç‹€æ…‹
        function startStatusChecker() {
            setInterval(async () => {
                const status = await fetchGameStatus();
                gameEnded = status.gameEnded;
                updateTimerDisplay(status.timeLeft);
                updateSubmitButton();
            }, 5000);
        }

        // æ›´æ–°è¨ˆæ™‚é¡¯ç¤º
        function updateTimerDisplay(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('time').textContent = 
                `${mins}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('gameStatus').textContent = 
                gameEnded ? 'â›” éŠæˆ²å·²çµæŸ' : 'ğŸŸ¢ é€²è¡Œä¸­';
        }

        // æ›´æ–°æäº¤æŒ‰éˆ•ç‹€æ…‹
        function updateSubmitButton() {
            const btn = document.querySelector('button');
            btn.disabled = !gameEnded;
            btn.textContent = gameEnded ? 'æäº¤æœ€çµ‚ç­”æ¡ˆ' : 'ç­‰å¾…éŠæˆ²çµæŸ';
        }

        window.onload = initGame;
    </script>
</body>
</html>