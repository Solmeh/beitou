<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北投探索配對</title>
    <style>
        .card {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            width: calc(50% - 20px);
            box-sizing: border-box;
            transition: transform 0.2s;
        }
        .card:active {
            transform: scale(0.98);
        }
        .selected {
            background-color: #ffeb3b;
            border-color: #ffc107;
        }
        .matched {
            background-color: #c8e6c9;
        }
        #timer {
            font-size: 1.5em;
            color: #d32f2f;
            padding: 10px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }
        @media (max-width: 600px) {
            .card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="timer">
        ⏳ 剩余时间：<span id="time">--:--</span>
        <div id="gameStatus"></div>
    </div>
    <div id="cardContainer"></div>
    <div class="submit-area">
        <input type="text" id="teamName" placeholder="輸入小組名稱" required>
        <button onclick="submitAnswers()" disabled>提交答案</button>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw5vmpkyiL6PTKlz5bda20SL15NV6jRdQ6ql342kGKxkQeKvLeHenJAhS2dz5e-sJz0/exec';
        let cards = [];
        let selectedCards = [];
        let matchedPairs = [];
        let gameEnded = false;

        // 初始化遊戲
        async function initGame() {
            try {
                // 獲取遊戲狀態
                const status = await fetchGameStatus();
                gameEnded = status.gameEnded;
                
                // 載入卡片資料
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getCards`);
                cards = await response.json();
                
                renderCards();
                startStatusChecker();
                updateSubmitButton();
            } catch (error) {
                console.error("遊戲初始化失敗：", error); 
                alert('遊戲初始化失敗，請稍後重試');
            }
        }

        // 渲染卡片
        function renderCards() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';
            
            cards.sort(() => Math.random() - 0.5).forEach(card => {
                const div = document.createElement('div');
                div.className = `card ${card.group}`;
                div.innerHTML = `
                    <h3>${card.location}</h3>
                    <p>${card.item}</p>
                    <div class="hint">${card.property}</div>
                `;
                div.onclick = () => !gameEnded && selectCard(div, card);
                container.appendChild(div);
            });
        }

        // 卡片選擇邏輯
        function selectCard(element, card) {
            element.classList.toggle('selected');
            const index = selectedCards.findIndex(c => c.element === element);
            
            if(index === -1) {
                selectedCards.push({ element, card });
            } else {
                selectedCards.splice(index, 1);
            }

            if(selectedCards.length === 2) {
                handlePair();
            }
        }

        // 處理配對
        function handlePair() {
            const [card1, card2] = selectedCards;
            const color = card1.card.group === card2.card.group ? 'green' : 'red';
            
            // 視覺反饋
            card1.element.style.borderColor = color;
            card2.element.style.borderColor = color;
            
            setTimeout(() => {
                card1.element.style.borderColor = '';
                card2.element.style.borderColor = '';
            }, 1000);

            matchedPairs.push([card1.card.id, card2.card.id]);
            selectedCards.forEach(c => c.element.classList.remove('selected'));
            selectedCards = [];
        }

        // 提交答案
        async function submitAnswers() {
            const team = document.getElementById('teamName').value;
            if (!team) return alert('請輸入小組名稱');

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'submit',
                        team: team,
                        matches: matchedPairs
                    })
                });
                alert('答案已提交！請等待最終結果');
            } catch (error) {
                alert('提交失敗，請檢查網路連線');
            }
        }

        // 遊戲狀態檢查
        async function fetchGameStatus() {
            const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getStatus`);
            return res.json();
        }

        // 定期檢查狀態
        function startStatusChecker() {
            setInterval(async () => {
                const status = await fetchGameStatus();
                gameEnded = status.gameEnded;
                updateTimerDisplay(status.timeLeft);
                updateSubmitButton();
            }, 5000);
        }

        // 更新計時顯示
        function updateTimerDisplay(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('time').textContent = 
                `${mins}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('gameStatus').textContent = 
                gameEnded ? '⛔ 遊戲已結束' : '🟢 進行中';
        }

        // 更新提交按鈕狀態
        function updateSubmitButton() {
            const btn = document.querySelector('button');
            btn.disabled = !gameEnded;
            btn.textContent = gameEnded ? '提交最終答案' : '等待遊戲結束';
        }

        window.onload = initGame;
    </script>
</body>
</html>